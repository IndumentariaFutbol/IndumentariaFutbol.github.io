<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tienda de Fútbol</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    /* Reset básicos */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      /* Colores inspirados en Canva con toque deportivo */
      --primary-color: #0d47a1; /* Azul oscuro - como un azul marino de uniforme */
      --secondary-color: #1976d2; /* Azul medio - vibrante, como el cielo */
      --accent-color: #ffc107; /* Amarillo oro - para acentos y cosas importantes */
      --light-bg: #e3f2fd; /* Fondo muy claro - como el aire en el campo */
      --card-bg: #fff; /* Fondo de tarjetas - limpio y blanco */
      --text-color: #212121; /* Texto oscuro - legible */
      --shadow-color: rgba(0, 0, 0, 0.1); /* Sombra suave */
      --gradient-start: #e3f2fd; /* Inicio del degradado del body */
      --gradient-end: #ffffff; /* Fin del degradado del body */
    }

    body {
      font-family: 'Poppins', sans-serif;
      /* Degradado sutil de fondo */
      background: linear-gradient(to bottom, var(--gradient-start), var(--gradient-end));
      color: var(--text-color);
      line-height: 1.6;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
      min-height: 100vh; /* Asegura que el degradado ocupe toda la altura */
      position: relative; /* Necesario para el pseudo-elemento de fondo */
      overflow-x: hidden; /* Evita scroll horizontal en móviles */
    }

    /* Pseudo-elemento para la imagen de fondo sutil */
    body::before {
      content: "";
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      /* Ejemplo de imagen de fondo: una textura de campo de fútbol o un patrón abstracto */
      /* Puedes cambiar esta URL por una que te guste más, por ejemplo, una sutil de campo o un patrón geométrico */
      background-image: url('https://user-images.githubusercontent.com/97834575/157488099-a8c6a0c5-5a5c-4a3e-be98-a3d8b5a0b7e4.jpg'); /* Textura de campo de fútbol */
      background-size: cover;
      background-position: center;
      opacity: 0.05; /* Muy sutil, para no distraer */
      z-index: -1; /* Asegura que esté detrás de todo el contenido */
      pointer-events: none; /* Evita que bloquee eventos de clic */
    }

    h1 {
      text-align: center;
      color: var(--primary-color);
      margin-bottom: 30px;
      font-size: 2.8em; /* Un poco más grande */
      font-weight: 700;
      letter-spacing: 0.05em;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.1); /* Sombra más pronunciada para el título */
      width: 100%;
      max-width: 900px;
    }

    .categoria,
    #carrito,
    #comprobante {
      background: var(--card-bg);
      border-radius: 12px; /* Más redondeado */
      padding: 25px; /* Más padding */
      margin-bottom: 25px;
      box-shadow: 0 8px 16px var(--shadow-color); /* Sombra más pronounced */
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      width: 100%;
      max-width: 900px;
      border: 1px solid rgba(0,0,0,0.05); /* Borde sutil */
    }

    .categoria:hover {
      transform: translateY(-5px); /* Pequeño levantamiento */
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15); /* Sombra más grande al pasar el ratón */
    }

    .categoria h2 {
      color: var(--secondary-color);
      font-size: 2em; /* Un poco más grande */
      margin-bottom: 15px;
      border-bottom: 2px solid #e0e0e0; /* Línea divisoria más clara */
      padding-bottom: 10px;
      font-weight: 600;
      cursor: pointer; /* Indica que es clicable */
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .categoria h2::after {
      content: '▼'; /* Flecha hacia abajo para indicar cerrado */
      font-size: 0.8em;
      transition: transform 0.3s ease;
    }

    .categoria.open h2::after {
      content: '▲'; /* Flecha hacia arriba para indicar abierto */
      transform: rotate(180deg);
    }

    .productos {
      display: grid; /* Usamos Grid para el layout de los productos */
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); /* Columnas responsivas */
      gap: 25px; /* Espacio entre productos */
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px dashed #e0e0e0; /* Línea punteada sutil */
      /* Propiedades para colapsar/expandir */
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.5s ease-out; /* Transición suave */
    }

    .categoria.open .productos {
      max-height: 2000px; /* Suficientemente grande para contener los productos */
      transition: max-height 0.7s ease-in; /* Transición de apertura */
    }

    .producto {
      background: #fdfdfd; /* Blanco casi puro para productos */
      border-radius: 10px;
      display: flex;
      flex-direction: column; /* Apila elementos en columna */
      align-items: center; /* Centra horizontalmente */
      padding: 20px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.08); /* Sombra suave para productos */
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      text-align: center; /* Centra el texto dentro del producto */
    }

    .producto:hover {
      transform: translateY(-3px); /* Ligeramente hacia arriba */
      box-shadow: 0 6px 12px rgba(0,0,0,0.12); /* Sombra ligeramente más grande */
    }

    .producto img {
      width: 180px; /* Tamaño de imagen más grande */
      height: auto;
      border-radius: 8px;
      border: 3px solid var(--secondary-color); /* Borde distintivo */
      object-fit: cover;
      margin-bottom: 15px; /* Espacio debajo de la imagen */
    }

    .producto-info {
      flex: 1; /* Permite que la info del producto ocupe el espacio restante */
      min-width: 100%; /* Ocupa todo el ancho disponible */
      display: flex;
      flex-direction: column;
      gap: 10px; /* Espacio entre el span y el botón */
      justify-content: center; /* Centra verticalmente */
      align-items: center;
    }

    .producto-info span {
      font-weight: 700;
      font-size: 1.2em; /* Precio más grande */
      color: var(--primary-color);
    }

    .producto button {
      background-color: var(--accent-color); /* Amarillo vibrante */
      color: var(--text-color); /* Texto oscuro para contraste */
      border: none;
      padding: 10px 20px;
      border-radius: 25px; /* Botones muy redondeados */
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
      font-size: 1em;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .producto button:hover {
      background-color: #ffb300; /* Un poco más oscuro */
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    #carrito h2,
    #comprobante h2 {
      color: var(--secondary-color);
      font-size: 2em;
      margin-bottom: 15px;
      border-bottom: 2px solid #e0e0e0;
      padding-bottom: 10px;
      font-weight: 600;
    }

    #listaCarrito {
        list-style: none;
        padding: 0;
        margin-bottom: 20px;
    }

    #listaCarrito li {
      margin-bottom: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      background-color: #f7f7f7; /* Fondo sutil para cada ítem del carrito */
      padding: 12px 18px;
      border-radius: 8px;
      border: 1px solid rgba(0,0,0,0.05);
      font-size: 1.05em;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    #listaCarrito li .item-details {
        flex-grow: 1;
        min-width: 180px;
        word-break: break-word;
        font-weight: 500;
        color: var(--text-color);
    }

    #listaCarrito button {
      background-color: #e53935; /* Rojo más fuerte */
      color: white;
      border: none;
      padding: 6px 10px;
      border-radius: 6px;
      margin-left: 15px;
      cursor: pointer;
      transition: background 0.3s ease;
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
      font-weight: normal; /* Botón de eliminar más ligero */
    }
    #listaCarrito button:hover {
        background-color: #c62828; /* Rojo más oscuro al hover */
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0,0,0,0.15);
    }


    /* Estilos para las notificaciones Toast */
    #toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      display: flex;
      flex-direction: column-reverse;
      align-items: flex-end;
    }

    .toast {
      background-color: #333;
      color: white;
      padding: 15px 30px; /* Más padding */
      border-radius: 10px; /* Más redondeado */
      margin-top: 12px;
      opacity: 0;
      transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
      transform: translateX(100%);
      box-shadow: 0 6px 20px rgba(0,0,0,0.3); /* Sombra más definida */
      max-width: 90%;
      text-align: center;
      font-weight: 600;
    }

    .toast.show {
      opacity: 1;
      transform: translateX(0);
    }

    .toast.success { background-color: #4CAF50; }
    .toast.error { background-color: #f44336; }
    .toast.info { background-color: #2196F3; }

    label {
        font-weight: 600;
        margin-top: 15px;
        display: block;
        margin-bottom: 5px;
        color: var(--text-color);
    }

    input[type="text"] {
      width: 100%;
      padding: 12px;
      margin-bottom: 15px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 1em;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.08);
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }

    input[type="text"]:focus {
        border-color: var(--secondary-color);
        box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.2); /* Sombra de enfoque azul */
        outline: none;
    }

    /* Botones generales de la tienda (Aplicar descuento, Finalizar compra, Copiar CVU) */
    .button-group button { /* Usar una clase para agrupar */
      background-color: var(--primary-color); /* Azul oscuro para los botones principales */
      color: white;
      border: none;
      padding: 12px 25px;
      font-weight: 700;
      border-radius: 25px; /* Muy redondeado */
      cursor: pointer;
      transition: background 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
      width: auto;
      display: inline-block;
      font-size: 1.05em;
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
      margin-top: 20px;
      margin-right: 10px; /* Espacio entre botones */
    }

    .button-group button:last-child {
        margin-right: 0;
    }

    .button-group button:hover {
      background-color: #003b8e; /* Un azul más oscuro */
      transform: translateY(-3px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.2);
    }

    #total,
    #totalDescuento,
    #totalPagado {
      font-weight: 700;
      color: var(--primary-color);
      font-size: 1.5em; /* Más grande */
      margin-top: 20px; /* Más espacio */
      display: block;
    }

    #totalDescuento {
        color: var(--accent-color); /* Color de acento para el total con descuento */
        font-size: 1.6em; /* Aún más grande */
    }
    #totalPagado {
        font-size: 2em; /* Gran tamaño para el total final */
        color: var(--secondary-color);
        margin-top: 25px;
    }

    /* Media Queries para una mejor adaptación */
    @media (max-width: 768px) {
      body { padding: 15px; }
      h1 { font-size: 2.2em; margin-bottom: 25px; }
      .categoria, #carrito, #comprobante { padding: 20px; margin-bottom: 20px; border-radius: 10px; }
      .categoria h2, #carrito h2, #comprobante h2 { font-size: 1.6em; }
      .productos { grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; }
      .producto { padding: 15px; border-radius: 8px; }
      .producto img { width: 150px; margin-bottom: 10px; }
      .producto-info span { font-size: 1.1em; }
      .producto button { padding: 8px 16px; font-size: 0.95em; border-radius: 20px; }
      #toast-container { right: 10px; left: 10px; align-items: center; }
      .toast { max-width: 100%; font-size: 0.9em; padding: 12px 25px; border-radius: 8px; }
      input[type="text"], .button-group button { padding: 10px 18px; font-size: 0.95em; border-radius: 20px; }
      #listaCarrito li { font-size: 0.95em; padding: 10px 15px; border-radius: 6px; }
      #listaCarrito button { padding: 5px 9px; border-radius: 4px; }
      #total, #totalDescuento, #totalPagado { font-size: 1.3em; }
      #totalDescuento { font-size: 1.4em; }
      #totalPagado { font-size: 1.8em; }
    }

    @media (max-width: 480px) {
      body { padding: 10px; }
      h1 { font-size: 1.8em; margin-bottom: 20px; }
      .categoria h2, #carrito h2, #comprobante h2 { font-size: 1.4em; }
      .categoria, #carrito, #comprobante { padding: 15px; margin-bottom: 15px; border-radius: 8px; }
      .productos { grid-template-columns: 1fr; gap: 15px; } /* Una sola columna en móviles pequeños */
      .producto { padding: 12px; border-radius: 6px; }
      .producto img { width: 120px; margin-bottom: 8px; }
      .producto-info span { font-size: 1em; }
      .producto button { padding: 8px 14px; font-size: 0.9em; border-radius: 18px; }
      input[type="text"], .button-group button { padding: 8px 15px; font-size: 0.9em; border-radius: 18px; display: block; margin-left: 0; margin-right: 0; width: 100%; } /* Botones y inputs ocupan todo el ancho */
      .button-group button + button { margin-top: 10px; } /* Espacio entre botones apilados */
      #listaCarrito li { font-size: 0.9em; padding: 8px 12px; border-radius: 5px; flex-direction: column; align-items: flex-start; } /* Apila ítems en carrito */
      #listaCarrito li .item-details { width: 100%; margin-bottom: 5px; }
      #listaCarrito button { padding: 4px 8px; border-radius: 3px; margin-left: 0; width: 100%; }
      #total, #totalDescuento, #totalPagado { font-size: 1.2em; }
      #totalDescuento { font-size: 1.3em; }
      #totalPagado { font-size: 1.6em; }
    }
  </style>
</head>
<body>
  <h1>Tienda de Fútbol</h1>

  <div class="categoria" id="categoria-botines">
    <h2 onclick="toggleCategoria('categoria-botines')">Botines</h2>
    <div class="productos" id="productos-botines">
      <div class="producto">
        <img src="https://i0.wp.com/www.sitemarca.com/wp-content/uploads/2019/07/Nike-Mercurial-360-2019-8.jpg" alt="Nike Mercurial">
        <div class="producto-info">
          <span>Botines Nike Mercurial - $110.000</span>
          <button onclick="agregarAlCarrito('Botines Nike Mercurial', 110000, 'nike-mercurial')">Agregar</button>
        </div>
      </div>
      <div class="producto">
        <img src="https://assets.adidas.com/images/h_840,f_auto,q_auto,fl_lossy,c_fill,g_auto/6bf310c6ec0449c2b38c612751070302_9366/Botines_Predator_Elite_Terreno_Firme_Verde_IG8771_HM1.jpg" alt="Adidas Predator">
        <div class="producto-info">
          <span>Botines Adidas Predator - $125.000</span>
          <button onclick="agregarAlCarrito('Botines Adidas Predator', 125000, 'adidas-predator')">Agregar</button>
        </div>
      </div>
      <div class="producto">
        <img src="https://brunch.com.ar/wp-content/uploads/2021/04/IMG_7435-scaled.jpg" alt="Puma Future">
        <div class="producto-info">
          <span>Botines Puma Future - $95.000</span>
          <button onclick="agregarAlCarrito('Botines Puma Future', 95000, 'puma-future')">Agregar</button>
        </div>
      </div>
    </div>
  </div>

  <div class="categoria" id="categoria-camisetas">
    <h2 onclick="toggleCategoria('categoria-camisetas')">Camisetas</h2>
    <div class="productos" id="productos-camisetas">
      <div class="producto">
        <img src="https://acdn-us.mitiendanube.com/stores/001/106/550/products/arg1-8c236e7773ecab0d2916638527231867-640-0.jpg" alt="Camiseta Argentina">
        <div class="producto-info">
          <span>Camiseta Argentina 2022 - $65.000</span>
          <button onclick="agregarAlCarrito('Camiseta Argentina 2022', 65000, 'camiseta-arg')">Agregar</button>
        </div>
      </div>
      <div class="producto">
        <img src="https://acdn-us.mitiendanube.com/stores/001/312/744/products/brasil-photoroom-a3a484bc3d2b5d7e0617252271407052-480-0.jpg" alt="Camiseta Brasil">
        <div class="producto-info">
          <span>Camiseta Brasil 2024 - $60.000</span>
          <button onclick="agregarAlCarrito('Camiseta Brasil 2024', 60000, 'camiseta-brasil')">Agregar</button>
        </div>
      </div>
      <div class="producto">
        <img src="https://acdn-us.mitiendanube.com/stores/006/105/140/products/3179c1e6-f624616f187c28128e17171953608769-1024-1024.jpg" alt="Camiseta Real Madrid">
        <div class="producto-info">
          <span>Camiseta Real Madrid 2024 - $70.000</span>
          <button onclick="agregarAlCarrito('Camiseta Real Madrid 2024', 70000, 'camiseta-rm')">Agregar</button>
        </div>
      </div>
    </div>
  </div>

  <div class="categoria" id="categoria-pelotas">
    <h2 onclick="toggleCategoria('categoria-pelotas')">Pelotas</h2>
    <div class="productos" id="productos-pelotas">
      <div class="producto">
        <img src="https://assets.adidas.com/images/h_840,f_auto,q_auto,fl_lossy,c_fill,g_auto/25447a2fbfa045e39665af3800f13511_9366/Pelota_Oceaunz_Club_Blanco_H57805_01_standard.jpg" alt="Pelota Adidas Training">
        <div class="producto-info">
          <span>Pelota Adidas Training - $30.000</span>
          <button onclick="agregarAlCarrito('Pelota Adidas Training', 30000, 'pelota-adidas-training')">Agregar</button>
        </div>
      </div>
      <div class="producto">
        <img src="https://assets.adidas.com/images/h_840,f_auto,q_auto,fl_lossy,c_fill,g_auto/fc233e7589d84c6ea40aaf720087a324_9366/Pelota_de_Futbol_N%C2%B05_Rojo_HT2487_01_standard.jpg" alt="Pelota Adidas World Cup">
        <div class="producto-info">
          <span>Pelota Adidas World Cup - $40.000</span>
          <button onclick="agregarAlCarrito('Pelota Adidas World Cup', 40000, 'pelota-adidas-worldcup')">Agregar</button>
        </div>
      </div>
      <div class="producto">
        <img src="https://tienda.umbro.com.ar/media/catalog/product/cache/cf274d8520268e31ef407671175657b9/u/m/umbro_pelota-f_tbol_force-tango_rojo_frente.jpg" alt="Pelota Umbro Force">
        <div class="producto-info">
          <span>Pelota Umbro Force - $25.000</span>
          <button onclick="agregarAlCarrito('Pelota Umbro Force', 25000, 'pelota-umbro-force')">Agregar</button>
        </div>
      </div>
    </div>
  </div>


  <div id="carrito">
    <h2>Carrito de Compras</h2>
    <ul id="listaCarrito"></ul>
    <p><strong>Total:</strong> $<span id="total">0.00</span></p>

    <label for="codigo">Código de descuento:</label>
    <input type="text" id="codigo" placeholder="Escribe tu código">
    <div class="button-group">
        <button onclick="aplicarDescuento()">Aplicar descuento</button>
    </div>

    <p><strong>Total con descuento:</strong> $<span id="totalDescuento">0.00</span></p>

    <div class="button-group">
        <button onclick="finalizarCompra()">Finalizar compra</button>
    </div>
  </div>

  <div id="comprobante" style="display: none;">
    <h2>Comprobante de Compra</h2>
    <p><strong>ID de Pedido:</strong> <span id="idPedidoComprobante"></span></p>
    <ul id="resumenCompra"></ul>
    <p><strong>Total Pagado:</strong> $<span id="totalPagado"></span></p>
    <p>Gracias por tu compra. Se ha enviado un comprobante al administrador.</p>
  </div>

  <form id="formularioCompra" action="https://formspree.io/f/manorawy" method="POST" style="display:none;">
    <input type="hidden" name="id_pedido" id="inputIdPedido"> <input type="hidden" name="resumen_pedido" id="inputResumen">
    <input type="hidden" name="total_final_pedido" id="inputTotal">
    </form>

  <div id="toast-container"></div>

  <div style="margin-top: 30px; text-align: center;">
    <div class="button-group">
        <button onclick="copiarCVU()">Copiar CVU para pago</button>
    </div>
  </div>

  <script>
    let carrito = [];
    let totalBruto = 0; // Total sin descuentos
    let totalFinal = 0; // Total con descuentos aplicados
    let descuentoAplicado = { tipo: null, valor: 0, codigo: null }; // Para rastrear el descuento activo
    let openCategoryId = null; // Para controlar qué categoría está abierta

    // Estructura de productos para una mejor gestión y futuras expansiones
    const productosDisponibles = {
        'nike-mercurial': { nombre: 'Botines Nike Mercurial', precio: 110000 },
        'adidas-predator': { nombre: 'Botines Adidas Predator', precio: 125000 },
        'puma-future': { nombre: 'Botines Puma Future', precio: 95000 },
        'camiseta-arg': { nombre: 'Camiseta Argentina 2022', precio: 65000 },
        'camiseta-brasil': { nombre: 'Camiseta Brasil 2024', precio: 60000 },
        'camiseta-rm': { nombre: 'Camiseta Real Madrid 2024', precio: 70000 },
        'pelota-adidas-training': { nombre: 'Pelota Adidas Training', precio: 30000 },
        'pelota-adidas-worldcup': { nombre: 'Pelota Adidas World Cup', precio: 40000 },
        'pelota-umbro-force': { nombre: 'Pelota Umbro Force', precio: 25000 }
    };

    // Códigos de descuento con tipos: 'porcentaje' o 'fijo'
    const codigosDescuento = {
        // --- CÓDIGO DE TESTEO ESPECIAL (solo para ti) ---
        "ERICESPECIAL$0": { tipo: 'especial_gratis', valor: 0 }, // Deja el total en 0

        // --- CÓDIGOS NORMALES PARA CLIENTES ---
        "PRIMERACOMPRA": { tipo: 'porcentaje', valor: 15 }, // 15% de descuento en la primera compra
        "GANAGOL": { tipo: 'fijo', valor: 20000 }, // Descuento fijo de $20.000
        "OFERTA25": { tipo: 'porcentaje', valor: 25 }, // 25% de descuento
        "AMIGOS10": { tipo: 'porcentaje', valor: 10 } // 10% de descuento
    };

    const miCVU = "0000003100002113037276"; // ¡CAMBIA ESTO POR TU CVU REAL!

    // --- Funciones de Utilidad ---

    function showToast(message, type = 'info', duration = 3000) {
        const toastContainer = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        toastContainer.appendChild(toast);

        setTimeout(() => {
            toast.classList.add('show');
        }, 10);

        setTimeout(() => {
            toast.classList.remove('show');
            toast.addEventListener('transitionend', () => toast.remove());
        }, duration);
    }

    // Nueva función para el manejo de categorías colapsables
    function toggleCategoria(categoryId) {
        const targetCategory = document.getElementById(categoryId);

        if (targetCategory.classList.contains('open')) {
            // Si la categoría ya está abierta, la cerramos
            targetCategory.classList.remove('open');
            openCategoryId = null;
        } else {
            // Si hay otra categoría abierta, la cerramos primero
            if (openCategoryId && openCategoryId !== categoryId) {
                document.getElementById(openCategoryId).classList.remove('open');
            }
            // Abrimos la categoría clicada
            targetCategory.classList.add('open');
            openCategoryId = categoryId;
        }
    }

    function agregarAlCarrito(nombre, precio, idProducto) {
        const itemExistente = carrito.find(item => item.id === idProducto);

        if (itemExistente) {
            itemExistente.cantidad++;
            itemExistente.subtotal = itemExistente.cantidad * itemExistente.precio;
        } else {
            carrito.push({ id: idProducto, nombre, precio, cantidad: 1, subtotal: precio });
        }
        actualizarCarrito();
        showToast(`"${nombre}" añadido al carrito!`, 'success');
    }

    function eliminarDelCarrito(idProducto) {
        const itemIndex = carrito.findIndex(item => item.id === idProducto);

        if (itemIndex > -1) {
            if (carrito[itemIndex].cantidad > 1) {
                carrito[itemIndex].cantidad--;
                carrito[itemIndex].subtotal = carrito[itemIndex].cantidad * carrito[itemIndex].precio;
            } else {
                carrito.splice(itemIndex, 1);
            }
            actualizarCarrito();
            showToast('Producto eliminado del carrito.', 'info');
        }
    }

    function actualizarCarrito() {
        const lista = document.getElementById('listaCarrito');
        lista.innerHTML = '';
        totalBruto = 0;

        carrito.forEach(item => {
            const li = document.createElement('li');
            li.innerHTML = `
                <div class="item-details">
                    ${item.nombre} (x${item.cantidad}) - $${item.subtotal.toLocaleString('es-AR')}
                </div>
                <div>
                    <button onclick="eliminarDelCarrito('${item.id}')">X</button>
                </div>
            `;
            lista.appendChild(li);
            totalBruto += item.subtotal;
        });

        document.getElementById('total').textContent = totalBruto.toLocaleString('es-AR');
        aplicarDescuento(true); // Recalcular totalFinal al actualizar el carrito
    }

    function aplicarDescuento(recalcular = false) {
        const codigoInput = document.getElementById('codigo');
        const codigo = codigoInput.value.trim().toUpperCase();
        const descuentoInfo = codigosDescuento[codigo];

        let mensajeDescuento = '';
        let tipoMensaje = 'info';

        if (!recalcular) {
            if (descuentoInfo) {
                descuentoAplicado = { tipo: descuentoInfo.tipo, valor: descuentoInfo.valor, codigo: codigo };
                if (descuentoInfo.tipo === 'especial_gratis') {
                    mensajeDescuento = `¡Descuento especial "${codigo}" utilizado! Valor: $0`;
                } else {
                    mensajeDescuento = `Código "${codigo}" aplicado correctamente.`;
                }
                tipoMensaje = 'success';
            } else if (codigo === "" && descuentoAplicado.codigo) {
                descuentoAplicado = { tipo: null, valor: 0, codigo: null };
                mensajeDescuento = 'Descuento reseteado.';
                tipoMensaje = 'info';
            } else {
                descuentoAplicado = { tipo: null, valor: 0, codigo: null };
                mensajeDescuento = 'Código de descuento inválido o no encontrado.';
                tipoMensaje = 'error';
            }
            showToast(mensajeDescuento, tipoMensaje);
        }

        let tempTotal = totalBruto;
        if (descuentoAplicado.tipo === 'porcentaje') {
            tempTotal = totalBruto - (totalBruto * descuentoAplicado.valor / 100);
        } else if (descuentoAplicado.tipo === 'fijo') {
            tempTotal = totalBruto - descuentoAplicado.valor;
        } else if (descuentoAplicado.tipo === 'especial_gratis') {
            tempTotal = 0;
        }
        totalFinal = Math.max(0, tempTotal);

        document.getElementById('totalDescuento').textContent = totalFinal.toLocaleString('es-AR');
    }

    // Función para generar un ID de pedido único
    function generarIdPedido() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const seconds = String(now.getSeconds()).padStart(2, '0');
        const random = Math.floor(Math.random() * 9000) + 1000;

        return `PEDIDO-${year}${month}${day}-${hours}${minutes}${seconds}-${random}`;
    }

    function finalizarCompra() {
        if (carrito.length === 0) {
            showToast('El carrito está vacío. Agrega productos para finalizar la compra.', 'error');
            return;
        }

        const idPedido = generarIdPedido();

        const resumen = document.getElementById('resumenCompra');
        resumen.innerHTML = '';
        let resumenTexto = '';

        carrito.forEach(item => {
            const li = document.createElement('li');
            li.textContent = `${item.nombre} (x${item.cantidad}) - $${item.subtotal.toLocaleString('es-AR')}`;
            resumen.appendChild(li);
            resumenTexto += `${item.nombre} (x${item.cantidad}) - $${item.subtotal.toLocaleString('es-AR')}\n`;
        });

        aplicarDescuento(true);
        document.getElementById('totalPagado').textContent = totalFinal.toLocaleString('es-AR');
        document.getElementById('idPedidoComprobante').textContent = idPedido;

        // 1. Preparar mensaje para Instagram DM y Copiado
        let instagramMessage = `¡Hola! He realizado una compra en tu tienda de Indumentaria de Fútbol.\n\n`;
        instagramMessage += `ID del Pedido: ${idPedido}\n\n`;
        instagramMessage += resumenTexto;
        instagramMessage += `\nTotal a pagar: $${totalFinal.toLocaleString('es-AR')}\n`;
        instagramMessage += `\nMi nombre es [Tu Nombre] y mi Instagram es @[Tu Instagram] para coordinar el pago y envío.`;
        instagramMessage += `\n\nEsperamos tu mensaje para avanzar con el pedido.`;

        const instagramUsername = 'recargas_ff_express'; // Tu usuario de Instagram
        const instagramURL = `https://ig.me/m/${instagramUsername}`;

        // 2. Enviar a Formspree (comprobante por Gmail)
        const formularioCompra = document.getElementById('formularioCompra');
        document.getElementById('inputIdPedido').value = idPedido;
        document.getElementById('inputResumen').value = `Pedido en IndumentariaFutbol.github.io:\n\nID del Pedido: ${idPedido}\n\n${resumenTexto}\nTotal final: $${totalFinal.toLocaleString('es-AR')}`;
        document.getElementById('inputTotal').value = totalFinal.toLocaleString('es-AR');

        // Copiar el mensaje a Instagram automáticamente (antes de la redirección de Formspree)
        navigator.clipboard.writeText(instagramMessage).then(() => {
            showToast('¡Mensaje del pedido copiado! Pégalo en Instagram ✅ Redirigiendo...', 'success', 5000);
        }).catch(err => {
            console.error('Error al copiar el mensaje a Instagram:', err);
            showToast('No se pudo copiar el mensaje automáticamente. Abre Instagram y coordina manualmente.', 'error', 7000);
        });

        // Redirigir a Instagram en una nueva pestaña (para que el usuario lo tenga listo)
        setTimeout(() => {
            window.open(instagramURL, '_blank');
        }, 2000);

        // Mostrar comprobante en la página (antes de que la página se redirija)
        document.getElementById('comprobante').style.display = 'block';

        // Limpiar carrito (también antes de la redirección)
        carrito = [];
        descuentoAplicado = { tipo: null, valor: 0, codigo: null };
        document.getElementById('codigo').value = '';
        actualizarCarrito();

        // Finalmente, envía el formulario a Formspree, lo que causará la redirección de la PÁGINA ACTUAL
        formularioCompra.submit();
    }

    function copiarCVU() {
        navigator.clipboard.writeText(miCVU).then(() => {
            showToast('CVU copiado al portapapeles ✅', 'success');
        }).catch(err => {
            showToast('No se pudo copiar el CVU. Por favor, cópialo manualmente.', 'error');
        });
    }

    // Inicializar el carrito y cerrar todas las categorías al cargar la página
    document.addEventListener('DOMContentLoaded', () => {
        actualizarCarrito();
        const categorias = document.querySelectorAll('.categoria');
        categorias.forEach(cat => {
            cat.classList.remove('open');
        });
    });
  </script>
</body>
</html>
